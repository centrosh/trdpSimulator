<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>TRDP Simulator Dashboard</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 2rem; background-color: #f9fbfd; }
      h1 { color: #203040; }
      section { margin-bottom: 2rem; }
      table { border-collapse: collapse; width: 100%; background: #ffffff; }
      th, td { border: 1px solid #cbd5e1; padding: 0.5rem 0.75rem; text-align: left; }
      th { background-color: #e2e8f0; text-transform: uppercase; font-size: 0.85rem; }
      tbody tr:nth-child(even) { background-color: #f1f5f9; }
      .status { font-weight: 600; }
      .telemetry { font-family: monospace; }
      button { padding: 0.4rem 1rem; margin-right: 0.5rem; border-radius: 4px; border: 1px solid #3b82f6; background-color: #3b82f6; color: #fff; cursor: pointer; }
      button.secondary { background-color: #fff; color: #1d4ed8; }
    </style>
  </head>
  <body>
    <h1>TRDP Simulator Control Center</h1>
    <p>
      Use this dashboard to browse catalogue assets, start automation runs, and monitor
      telemetry generated by the simulator. The controls below communicate with the
      REST API provided by <code>trdp_sim_api</code>.
    </p>

    <section>
      <h2>Scenario Catalogue</h2>
      <table id="scenario-table">
        <thead>
          <tr>
            <th>Identifier</th>
            <th>Device</th>
            <th>Events</th>
            <th>Source</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>Device Profiles</h2>
      <table id="device-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Source</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>Run Telemetry</h2>
      <div>
        <label>
          Scenario ID
          <input id="scenario-id" value="demo" />
        </label>
        <button id="start-run">Start Run</button>
        <button id="pause-run" class="secondary">Pause</button>
        <button id="resume-run" class="secondary">Resume</button>
      </div>
      <div id="run-status"></div>
      <pre id="telemetry" class="telemetry"></pre>
    </section>

    <script>
      const API_URL = "";
      let activeRunId = null;

      async function fetchJson(path, options = {}) {
        const response = await fetch(`${API_URL}${path}`, {
          headers: {"Content-Type": "application/json"},
          ...options,
        });
        if (!response.ok) {
          const detail = await response.text();
          throw new Error(detail);
        }
        return response.json();
      }

      async function loadCatalogue() {
        const scenarios = await fetchJson('/scenarios');
        const scenarioBody = document.querySelector('#scenario-table tbody');
        scenarioBody.innerHTML = '';
        scenarios.items.forEach((item) => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${item.id}</td><td>${item.device}</td><td>${item.events}</td><td>${item.path}</td>`;
          scenarioBody.appendChild(row);
        });

        const devices = await fetchJson('/devices');
        const deviceBody = document.querySelector('#device-table tbody');
        deviceBody.innerHTML = '';
        devices.items.forEach((item) => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${item.name}</td><td>${item.path}</td>`;
          deviceBody.appendChild(row);
        });
      }

      async function refreshStatus() {
        if (!activeRunId) {
          return;
        }
        try {
          const status = await fetchJson(`/runs/${activeRunId}`);
          document.querySelector('#run-status').textContent = `Run ${status.run_id} state=${status.state}`;
          document.querySelector('#telemetry').textContent = (status.telemetry || []).join('\n');
          if (status.state === 'completed' || status.state === 'failed') {
            activeRunId = null;
          }
        } catch (err) {
          document.querySelector('#run-status').textContent = err.message;
        }
      }

      async function startRun() {
        const scenarioId = document.querySelector('#scenario-id').value.trim();
        const response = await fetchJson('/runs', {
          method: 'POST',
          body: JSON.stringify({scenario_id: scenarioId, messages: []}),
        });
        activeRunId = response.run_id;
        await refreshStatus();
      }

      async function pauseRun() {
        if (!activeRunId) {
          return;
        }
        await fetchJson(`/runs/${activeRunId}/pause`, {method: 'POST'});
        await refreshStatus();
      }

      async function resumeRun() {
        if (!activeRunId) {
          return;
        }
        await fetchJson(`/runs/${activeRunId}/resume`, {method: 'POST'});
        await refreshStatus();
      }

      document.getElementById('start-run').addEventListener('click', () => startRun().catch(alert));
      document.getElementById('pause-run').addEventListener('click', () => pauseRun().catch(alert));
      document.getElementById('resume-run').addEventListener('click', () => resumeRun().catch(alert));

      loadCatalogue().catch((err) => {
        document.querySelector('#scenario-table tbody').innerHTML = `<tr><td colspan="4">${err.message}</td></tr>`;
      });

      setInterval(refreshStatus, 2000);
    </script>
  </body>
</html>
